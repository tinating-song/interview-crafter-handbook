# æ˜é‡‘æŠ€æœ¯æ–‡ç«  - ç¬¬2ç¯‡

## æ ‡é¢˜
**AIäº§å“ç»ç†å¿…æ‡‚ï¼šé«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡å…¨è§£æ**

## æ–‡ç« åˆ†ç±»
- åç«¯
- æ¶æ„
- ç³»ç»Ÿè®¾è®¡
- AIäº§å“

---

## æ­£æ–‡

ä½œä¸ºä¸€åAIäº§å“ç»ç†ï¼Œé¢è¯•æ—¶ç»å¸¸è¢«é—®åˆ°**ç³»ç»Ÿè®¾è®¡é¢˜**ï¼š

"è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ"
"å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢"
"æ¨èç³»ç»Ÿæ€ä¹ˆåšå†·å¯åŠ¨"

å¾ˆå¤šPMå› ä¸ºç¼ºä¹ç³»ç»Ÿè®¾è®¡çŸ¥è¯†ï¼Œé¢è¯•æ—¶åªèƒ½æ³›æ³›è€Œè°ˆ ğŸ˜°

ä»Šå¤©æˆ‘ç”¨ä¸€ä¸ª**é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡æ¡ˆä¾‹**ï¼Œç³»ç»Ÿè®²è§£æ¶æ„æ€è·¯ ğŸ’¡

---

## ğŸ¯ éœ€æ±‚åˆ†æ

### åŠŸèƒ½éœ€æ±‚
- ç”¨æˆ·å¯ä»¥å¿«é€ŸæŠ¢è´­å•†å“
- é˜²æ­¢è¶…å–
- å®æ—¶æ˜¾ç¤ºåº“å­˜
- æ”¯æŒé«˜å¹¶å‘

### éåŠŸèƒ½éœ€æ±‚
**é«˜å¹¶å‘**ï¼š
- QPSï¼š10000å†™/50000è¯»
- å“åº”æ—¶é—´ï¼š< 500ms
- å¯ç”¨æ€§ï¼š99.9%

**ä¸€è‡´æ€§**ï¼š
- åº“å­˜ä¸èƒ½è¶…å–
- è®¢å•ä¸èƒ½ä¸Ÿ

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CDN + WAF    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Load Balancer      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚         API Gateway Cluster      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            Nginx + Lua Script        â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
         â”‚  â”‚ Redis    â”‚  Kafka    â”‚         â”‚
         â”‚  â”‚ Cluster  â”‚  Cluster   â”‚         â”‚
         â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚       â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ç§’æ€æœåŠ¡é›†ç¾¤    â”‚    â”‚  è®¢å•æœåŠ¡é›†ç¾¤     â”‚
    â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”     â”‚    â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”     â”‚
    â”‚  â”‚Podâ”‚Podâ”‚  â”‚    â”‚    â”‚  â”‚Podâ”‚Podâ”‚  â”‚    â”‚
    â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”˜     â”‚    â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”˜     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚  æ•°æ®åº“é›†ç¾¤   â”‚
         â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”  â”‚
         â”‚  â”‚Masterâ”‚Slaveâ”‚  â”‚
         â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”˜  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. æœ¬åœ°ç¼“å­˜ï¼ˆRedisï¼‰

```
é—®é¢˜ï¼šå¦‚ä½•åœ¨QPS 50000çš„æƒ…å†µä¸‹ä¿è¯æ€§èƒ½ï¼Ÿ

æ–¹æ¡ˆï¼šä¸‰çº§ç¼“å­˜
L1: Nginxæœ¬åœ°ç¼“å­˜ï¼ˆçƒ­æ•°æ®ï¼Œ10msï¼‰
L2: Redisåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆæ¸©æ•°æ®ï¼Œ50msï¼‰
L3: æ•°æ®åº“ï¼ˆå†·æ•°æ®ï¼Œ200msï¼‰
```

**ç¼“å­˜ç­–ç•¥**ï¼š
- **çƒ­ç‚¹æ•°æ®**ï¼šåº“å­˜ä¿¡æ¯ã€å•†å“è¯¦æƒ…
- **ä¸»åŠ¨æ›´æ–°**ï¼šåº“å­˜å˜æ›´æ—¶æ¨é€æ›´æ–°
- **è¿‡æœŸæ—¶é—´**ï¼šç§’çº§è¿‡æœŸï¼Œé˜²æ­¢è„è¯»

#### 2. æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaï¼‰

```
é—®é¢˜ï¼šå¦‚ä½•ä¿è¯è®¢å•ä¸ä¸¢å¤±ï¼Ÿ

æ–¹æ¡ˆï¼šå¼‚æ­¥å‰Šå³°

æµç¨‹ï¼š
ä¸‹å• â†’ MQ â†’ æ¶ˆè´¹ â†’ å¼‚æ­¥å¤„ç†
  â†“       â†“
å‰Šå³°     è§£è€¦

ä¿è¯æœºåˆ¶ï¼š
- ç”Ÿäº§è€…ç¡®è®¤ï¼ˆWait for ACKï¼‰
- æ¶ˆè´¹è€…ç¡®è®¤ï¼ˆManual Commitï¼‰
- æ­»ä¿¡é˜Ÿåˆ—ï¼ˆæœªå¤„ç†æ¶ˆæ¯é‡è¯•ï¼‰
```

**åœºæ™¯**ï¼š
- ç§’æ€å¼€å§‹å‰ï¼šé¢„çƒ­æ¶ˆæ¯åˆ°é˜Ÿåˆ—
- ç§’æ€è¿›è¡Œä¸­ï¼šå‰Šå³°ï¼Œä¿æŠ¤ä¸‹æ¸¸
- ç§’æ€ç»“æŸåï¼šæ‰¹é‡å¤„ç†

#### 3. åº“å­˜æ‰£å‡

```
æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é˜²æ­¢è¶…å–ï¼Ÿ

æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“ä¹è§‚é”
BEGIN;
  quantity = SELECT quantity FROM inventory WHERE id = 123;
  IF quantity > 0 THEN
    UPDATE inventory SET quantity = quantity - 1 WHERE id = 123;
    -- åˆ›å»ºè®¢å•
    COMMIT;
  ELSE
  ROLLBACK;
END;

æ–¹æ¡ˆäºŒï¼šRedisåŸå­æ“ä½œ
-- Luaè„šæœ¬ä¿è¯åŸå­æ€§
local quantity = redis.call('GET', 'inventory:123')
if quantity > 0 then
  redis.call('DECRBY', 'inventory:123', 1)
  return 1
else
  return 0
end
```

**å¯¹æ¯”**ï¼š
- æ•°æ®åº“é”ï¼šç®€å•ä½†æœ‰æ€§èƒ½ç“¶é¢ˆ
- Redis Luaï¼šé«˜æ€§èƒ½ä½†é€»è¾‘å¤æ‚

---

## ğŸ“Š æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•

```
å¢åŠ QPSå®¹é‡ï¼š
å½“å‰ï¼š10,000 QPS
ç›®æ ‡ï¼š50,000 QPS

æ–¹æ¡ˆï¼š
1. å¢åŠ æœåŠ¡å®ä¾‹ï¼ˆä»10ä¸ª â†’ 50ä¸ªï¼‰
2. å¢åŠ Redisåˆ†ç‰‡ï¼ˆ3ä¸ª â†’ 6ä¸ªï¼‰
3. æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼ˆ1ä¸»2ä» â†’ 1ä¸»5ä»ï¼‰
```

### å‚ç›´æ‹†åˆ†

```
ä¸šåŠ¡å¢é•¿åçš„ç“¶é¢ˆï¼š
å•åº“ â†’ åˆ†åº“ â†’ åˆ†è¡¨

æ‹†åˆ†ç»´åº¦ï¼š
- æŒ‰ç”¨æˆ·IDåˆ†ç‰‡ï¼ˆå¦‚IDå°¾å·0-9ï¼‰
- æŒ‰ä¸šåŠ¡ç±»å‹åˆ†ç‰‡ï¼ˆç§’æ€åº“ã€æ™®é€šåº“ï¼‰
- æŒ‰æ—¶é—´åˆ†ç‰‡ï¼ˆå†å²åº“ã€å½“å‰åº“ï¼‰
```

---

## ğŸ”’ å®‰å…¨è®¾è®¡

### æ¶æ„è¯·æ±‚é˜²æŠ¤

| æ”»å‡»ç±»å‹ | é˜²å¾¡ç­–ç•¥ | å®ç°æ–¹å¼ |
|----------|----------|----------|
| åˆ·åº“æ”»å‡» | é™æµ | ä»¤ç‰Œæ¡¶/æ¼æ¡¶ç®—æ³• |
| æœºå™¨äºº | éªŒè¯ç  | å›¾å½¢éªŒè¯ç /æ»‘å— |
| å†…éƒ¨ä½œå¼Š | é£æ§ | ç”¨æˆ·è¡Œä¸ºåˆ†æ |
| SQLæ³¨å…¥ | å‚æ•°æ ¡éªŒ | é¢„å¤„ç†/å‚æ•°åŒ–æŸ¥è¯¢ |

### é™æµç®—æ³•

**ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰**ï¼š
```
ç®—æ³•ï¼š
1. æ¡¶å®¹é‡ï¼š100ä¸ªä»¤ç‰Œ
2. ç”Ÿæˆé€Ÿåº¦ï¼šæ¯ç§’10ä¸ªä»¤ç‰Œ
3. æ¶ˆè€—ï¼šæ¯æ¬¡è¯·æ±‚æ¶ˆè€—1ä¸ªä»¤ç‰Œ
4. æ‹’ç»ï¼šä»¤ç‰Œä¸ºç©ºæ—¶æ‹’ç»è¯·æ±‚

å®ç°ï¼š
def rate_limit(user_id):
    key = f"token:{user_id}"
    tokens = redis.get(key)
    if tokens is None:
        redis.set(key, 100, ex=60)  # åˆå§‹100ä¸ª
        tokens = 100

    if tokens > 0:
        redis.decr(key)
        return True
    else:
        return False  # é™æµ
```

**æ¼æ¡¶ï¼ˆLeaky Bucketï¼‰**ï¼š
```
ç®—æ³•ï¼š
1. æ¡¶å®¹é‡ï¼š100ä¸ªè¯·æ±‚
2. æ¼æ°´é€Ÿåº¦ï¼šæ¯ç§’10ä¸ªè¯·æ±‚
3. åŒ€é€Ÿæµå‡ºï¼šä¿è¯å¹³å‡é€Ÿç‡

å®ç°ï¼š
def leaky_bucket(user_id):
    key = f"leaky:{user_id}"
    capacity = 100  # æ¡¶å®¹é‡
    leak_rate = 10  # æ¼æ°´é€Ÿåº¦

    last_time = redis.get(f"{key}:time")
    current_water = redis.get(f"{key}:water")

    # è®¡ç®—æ¼æ°´é‡
    now = time.time()
    if last_time:
        elapsed = now - last_time
        leak = elapsed * leak_rate
        current_water = max(0, current_water - leak)

    # å°è¯•åŠ æ°´
    if current_water < capacity:
        redis.set(f"{key}:water", current_water + 1)
        redis.set(f"{key}:time", now)
        return True
    else:
        return False
```

---

## ğŸ¯ é¢è¯•å›ç­”æ¡†æ¶

**Q: è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ**

**å®Œæ•´å›ç­”ï¼ˆSTARæ³•åˆ™ï¼‰**ï¼š

```
ã€Sã€‘åœ¨ä¸Šä¸€å®¶å…¬å¸ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªç”µå•†ä¿ƒé”€åœºæ™¯ï¼Œ
éœ€è¦è®¾è®¡ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘çš„ç§’æ€ç³»ç»Ÿã€‚
æ ¸å¿ƒæŒ‘æˆ˜æ˜¯ï¼š
- QPSå³°å€¼è¾¾åˆ°50,000
- åº“å­˜åªæœ‰1000ä»¶
- éœ€è¦é˜²æ­¢è¶…å–å’Œè®¢å•ä¸¢å¤±

ã€Tã€‘æˆ‘çš„ç›®æ ‡æ˜¯è®¾è®¡ä¸€ä¸ªå¯æ¨ªå‘æ‰©å±•çš„æ¶æ„ï¼Œ
ä¿è¯ï¼š
- åº“å­˜ä¸€è‡´æ€§
- è®¢å•ä¸ä¸¢å¤±
- å“åº”æ—¶é—´ < 500ms
- å¯ç”¨æ€§ 99.9%

ã€Aã€‘æˆ‘çš„æ¶æ„è®¾è®¡åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

1. **ç¼“å­˜å±‚**ï¼šNginx + Redisä¸‰çº§ç¼“å­˜
   - çƒ­ç‚¹æ•°æ®æœ¬åœ°ç¼“å­˜ï¼ˆ10msï¼‰
   - Redisåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆ50msï¼‰
   - ä¸»åŠ¨æ›´æ–°ç­–ç•¥é˜²æ­¢è„è¯»

2. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šKafkaå¼‚æ­¥å‰Šå³°
   - ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶
   - æ­»ä¿¡é˜Ÿåˆ—é‡è¯•
   - å‰Šå³°ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡

3. **åº“å­˜æ‰£å‡**ï¼šRedis LuaåŸå­æ“ä½œ
   - é¿å…æ•°æ®åº“æˆä¸ºç“¶é¢ˆ
   - ä¿è¯åº“å­˜ä¸€è‡´æ€§
   - é«˜å¹¶å‘ä¸‹çš„åŸå­æ€§

4. **é™æµé˜²æŠ¤**ï¼šä»¤ç‰Œæ¡¶ç®—æ³•
   - æŒ‰ç”¨æˆ·IDé™æµ
   - æ¯ç§’100ä»¤ç‰Œç”Ÿæˆ
   - è¶…é™è¿”å›å‹å¥½æç¤º

5. **æœåŠ¡æ‰©å±•**ï¼šK8sè‡ªåŠ¨æ‰©ç¼©å®¹
   - æ ¹æ®CPU/å†…å­˜è‡ªåŠ¨è°ƒæ•´Podæ•°é‡
   - åº”å¯¹æµé‡æ´ªå³°

ã€Rã€‘æœ€ç»ˆç»“æœï¼š
- ç³»ç»Ÿç¨³å®šæ”¯æ’‘50,000 QPSï¼ˆè¶…å‡ºç›®æ ‡ï¼‰âœ…
- P99å»¶è¿Ÿæ§åˆ¶åœ¨300msä»¥å†… âœ…
- é›¶è¶…å–å’Œé›¶è®¢å•ä¸¢å¤± âœ…
- é€šè¿‡æ°´å¹³æ‰©å±•å¯æ”¯æŒ100,000 QPS
- è¿™ä¸ªæ¶æ„è®©æˆ‘è·å¾—äº†å¹´åº¦æœ€ä½³æŠ€æœ¯å¥–
```

---

## ğŸ“ˆ æ‰©å±•æ€è€ƒ

**Q: å¦‚ä½•æ”¯æŒ100ä¸‡ç”¨æˆ·åŒæ—¶åœ¨çº¿ï¼Ÿ**

**å›ç­”è¦ç‚¹**ï¼š
1. **è¯»å†™åˆ†ç¦»**ï¼šç§’æ€è¯»å¤šå†™å°‘ï¼Œåˆ†ç¦»æ•°æ®åº“
2. **CDNåŠ é€Ÿ**ï¼šé™æ€èµ„æºå…¨éƒ¨CDN
3. **æœåŠ¡é™çº§**ï¼šéæ ¸å¿ƒæœåŠ¡é™çº§ï¼Œä¿æ ¸å¿ƒ
4. **é¢„æ¡ˆå‡†å¤‡**ï¼šåˆ¶å®šå›æ»šå’Œé™çº§é¢„æ¡ˆ

---

## ğŸ å®Œæ•´ç‰ˆå†…å®¹

æœ¬æ‰‹å†Œ**ç³»ç»Ÿè®¾è®¡éƒ¨åˆ†**åŒ…å«ï¼š

- âœ… 13ä¸ªå®Œæ•´ç³»ç»Ÿè®¾è®¡æ¡ˆä¾‹
- âœ… æ¯ä¸ªæ¡ˆä¾‹éƒ½æœ‰æ¶æ„å›¾
- âœ… åŒ…å«ç§’æ€/æ¨è/IM/æ”¯ä»˜ç­‰
- âœ… è¯¦ç»†çš„QPSå®¹é‡ä¼°ç®—
- âœ… ç¼“å­˜/æ¶ˆæ¯é˜Ÿåˆ—/é™æµç­‰æ ¸å¿ƒç»„ä»¶è®¾è®¡

---

## è´­ä¹°æ–¹å¼

**GitHubå…è´¹é¢„è§ˆ**ï¼š
https://github.com/tinating-song/interview-crafter-handbook

**è´­ä¹°å®Œæ•´ç‰ˆï¼ˆÂ¥29ï¼‰**ï¼š
https://github.com/tinating-song/interview-crafter-handbook/blob/main/BUY.md

---

> ä½œè€…ï¼šAIäº§å“ç»ç†é¢è¯•æ‰‹å†Œ
>
æ ‡ç­¾ï¼šåç«¯ã€æ¶æ„ã€ç³»ç»Ÿè®¾è®¡ã€AIäº§å“ã€äº§å“ç»ç†ã€é¢è¯•å‡†å¤‡ã€é«˜å¹¶å‘
